<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>æ—¥çµŒ225å…ˆç‰© æ‰‹å‹•å…¥åŠ›ã‚«ã‚®è¶³ã‚·ã‚¹ãƒ†ãƒ </title>

<!-- Chart.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

<!-- PWA / Mobile meta -->
<link rel="manifest" href="manifest.webmanifest">
<link rel="apple-touch-icon" href="icon-192.png">
<meta name="theme-color" content="#1a1a2e">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<style>
/* â”€â”€â”€â”€â”€ ãƒ‡ã‚¶ã‚¤ãƒ³ï¼ˆãƒ™ãƒ¼ã‚¹ï¼‰ â”€â”€â”€â”€â”€ */
*{margin:0;padding:0;box-sizing:border-box;}
body{
  font-family:'Segoe UI',Tahoma,sans-serif;
  background:linear-gradient(135deg,#1e3c72,#2a5298);
  /* ãƒ¢ãƒã‚¤ãƒ«ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼é«˜ã•å¤‰å‹•ã«å¼·ã„ */
  min-height:100dvh;
  padding:20px;
  /* iOSãƒãƒƒãƒå¯¾å¿œ */
  padding-bottom:calc(20px + env(safe-area-inset-bottom));
}
.container{max-width:1600px;margin:0 auto;background:#fff;border-radius:20px;box-shadow:0 20px 40px rgba(0,0,0,.1);overflow:hidden;}
.header{background:linear-gradient(135deg,#1a1a2e,#16213e);color:#fff;padding:30px;text-align:center;}
.header h1{font-size:2.4em;font-weight:300;margin-bottom:10px;}
.status-indicator{display:inline-flex;align-items:center;gap:8px;font-size:1.1em;margin-top:10px;}
.status-dot{width:12px;height:12px;border-radius:50%;background:#f39c12;animation:pulse 2s infinite;}
@keyframes pulse{0%{opacity:1}50%{opacity:.5}100%{opacity:1}}
.main-grid{display:grid;grid-template-columns:350px 1fr;min-height:calc(100vh - 200px);}
.control-panel{background:#f8f9fa;padding:25px;border-right:1px solid #e9ecef;overflow-y:auto;}
.chart-area{padding:25px;display:flex;flex-direction:column;}
.section-title{font-size:1.2em;font-weight:700;color:#2c3e50;margin-bottom:20px;padding-bottom:10px;border-bottom:3px solid #3498db;}
.control-group{background:#fff;border-radius:12px;padding:20px;margin-bottom:20px;box-shadow:0 4px 6px rgba(0,0,0,.05);}
.control-group h3{margin-bottom:15px;color:#34495e;font-size:1em;}
.input-group{margin-bottom:15px;}
.input-group label{display:block;margin-bottom:8px;font-weight:500;color:#2c3e50;font-size:.9em;}
.form-control{width:100%;padding:12px;border:2px solid #e1e8ed;border-radius:8px;font-size:1em;transition:.3s;}
.form-control:focus{outline:none;border-color:#3498db;box-shadow:0 0 0 3px rgba(52,152,219,.1);}
.price-input-row{display:flex;gap:10px;align-items:end;}
.price-input-row .form-control{flex:1;}
.btn{padding:12px 20px;border:none;border-radius:8px;font-size:1em;font-weight:600;cursor:pointer;transition:.3s;width:100%;margin-bottom:10px;}
.btn-small{padding:8px 12px;font-size:.9em;width:auto;margin-bottom:0;min-width:80px;}
.btn-primary{background:linear-gradient(135deg,#3498db,#2980b9);color:#fff;}
.btn-primary:hover{background:linear-gradient(135deg,#2980b9,#1f639a);transform:translateY(-2px);box-shadow:0 4px 12px rgba(52,152,219,.3);}
.btn-success{background:linear-gradient(135deg,#27ae60,#229954);color:#fff;}
.btn-success:hover{background:linear-gradient(135deg,#229954,#1e8449);transform:translateY(-2px);}
.btn-danger{background:linear-gradient(135deg,#e74c3c,#c0392b);color:#fff;}
.btn-danger:hover{background:linear-gradient(135deg,#c0392b,#a93226);transform:translateY(-2px);}
.btn-secondary{background:linear-gradient(135deg,#95a5a6,#7f8c8d);color:#fff;}
.btn-warning{background:linear-gradient(135deg,#f39c12,#e67e22);color:#fff;}
.status-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:20px;}
.status-card{background:#fff;padding:15px;border-radius:10px;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,.1);border-left:4px solid #3498db;}
.status-value{font-size:1.3em;font-weight:bold;color:#2c3e50;}
.status-label{font-size:.85em;color:#7f8c8d;margin-top:5px;}
.chart-container{flex:1;min-height:400px;height:500px;background:#fff;border-radius:15px;padding:20px;box-shadow:0 8px 25px rgba(0,0,0,.1);}
.data-log{background:#2c3e50;color:#ecf0f1;border-radius:10px;padding:15px;margin-top:20px;font-family:'Courier New',monospace;font-size:.9em;max-height:150px;overflow-y:auto;}
.log-entry{margin-bottom:5px;padding:3px 0;border-bottom:1px solid rgba(255,255,255,.1);}
.timestamp{color:#3498db;font-weight:bold;}
.price-up{color:#27ae60;} .price-down{color:#e74c3c;}
.alert{padding:12px;border-radius:8px;margin-bottom:15px;font-size:.9em;}
.alert-info{background:#d1ecf1;border:1px solid #bee5eb;color:#0c5460;}
.alert-warning{background:#fff3cd;border:1px solid #ffeaa7;color:#856404;}
.recent-prices{max-height:200px;overflow-y:auto;border:1px solid #e9ecef;border-radius:8px;padding:10px;background:#f8f9fa;}
.price-entry{display:flex;justify-content:space-between;align-items:center;padding:5px 0;border-bottom:1px solid #e9ecef;font-size:.9em;}
.price-entry:last-child{border-bottom:none;}

/* ===== ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«åˆ¶å¾¡ãƒ‘ãƒãƒ« ===== */
.chart-controls{display:flex;align-items:center;gap:15px;margin-bottom:15px;padding:12px;background:#f8f9fa;border-radius:8px;}
.chart-controls label{font-weight:600;color:#2c3e50;white-space:nowrap;}
.chart-controls input[type="range"]{flex:1;margin:0 10px;}
.chart-controls .range-info{font-size:0.9em;color:#7f8c8d;white-space:nowrap;min-width:120px;}
.zoom-buttons{display:flex;gap:5px;}
.zoom-buttons button{padding:6px 12px;font-size:0.85em;border:1px solid #ddd;background:#fff;border-radius:4px;cursor:pointer;}
.zoom-buttons button:hover{background:#f0f0f0;}

/* ===== ãƒªã‚¹ãƒˆå…±é€šï¼ˆå‰Šé™¤UIï¼‰ ===== */
.manage-list{list-style:none;padding:0;margin:0;max-height:180px;overflow-y:auto;border:1px solid #e9ecef;border-radius:8px;}
.manage-item{display:flex;gap:10px;justify-content:space-between;align-items:center;padding:8px 10px;border-bottom:1px solid #f0f2f5;font-size:.9em;}
.manage-item:last-child{border-bottom:none;}
.item-meta{display:flex;flex-direction:column;gap:2px;}
.item-actions{display:flex;gap:8px;align-items:center;}

@media(max-width:1200px){
  .main-grid{grid-template-columns:1fr;}
  .control-panel{border-right:none;border-bottom:1px solid #e9ecef;}
  .header h1{font-size:1.8em;}
}
/* â”€â”€â”€â”€â”€ CSS end â”€â”€â”€â”€â”€ */
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>ğŸ“ˆ æ—¥çµŒ225å…ˆç‰© æ‰‹å‹•å…¥åŠ›ã‚«ã‚®è¶³</h1>
    <div class="status-indicator"><div class="status-dot"></div><span>æ‰‹å‹•å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰</span></div>
  </div>

  <div class="main-grid">

    <!-- å·¦ãƒ‘ãƒãƒ« -->
    <div class="control-panel">
      <div class="section-title">âœï¸ æ‰‹å‹•å…¥åŠ›</div>

      <!-- ä¾¡æ ¼å…¥åŠ› -->
      <div class="control-group">
        <h3>ä¾¡æ ¼å…¥åŠ›</h3>
        <div class="input-group">
          <label>ç¾åœ¨ä¾¡æ ¼ (å††)</label>
          <div class="price-input-row">
            <input type="number" class="form-control" id="priceInput" placeholder="ä¾‹: 33500" step="1" min="10000" max="50000" inputmode="numeric" pattern="\d*">
            <button type="button" class="btn btn-success btn-small" id="addPriceBtn">è¿½åŠ </button>
          </div>
        </div>
        <div class="input-group">
          <label>æ—¥æ™‚ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</label>
          <input type="datetime-local" class="form-control" id="datetimeInput">
        </div>
      </div>

      <!-- ã‚«ã‚®è¶³ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ -->
      <div class="control-group">
        <h3>ã‚«ã‚®è¶³ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼</h3>
        <div class="input-group">
          <label>è»¢æ›ç‡ (%)</label>
          <input type="number" class="form-control" id="reversalPercent" value="0.1" step="0.01" min="0.01" max="10">
        </div>
        <button type="button" class="btn btn-warning" id="recalculateBtn">ğŸ”„ å†è¨ˆç®—</button>
      </div>

      <!-- å£²è²·ãƒãƒ¼ã‚¯ï¼ˆè¿½åŠ ãƒ»ç®¡ç†ï¼‰ -->
      <div class="control-group">
        <h3>å£²è²·è¨˜éŒ²</h3>
        <div class="input-group">
          <label>å–å¼•ã‚¿ã‚¤ãƒ—</label>
          <select class="form-control" id="tradeType">
            <option value="buy">è²·ã„ (BUY)</option>
            <option value="sell">å£²ã‚Š (SELL)</option>
          </select>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;">
          <button type="button" class="btn btn-primary btn-small" id="addTradeBtn">âœ… ãƒãƒ¼ã‚¯</button>
          <button type="button" class="btn btn-danger btn-small" id="deleteSelectedTradeBtn">ğŸ—‘ é¸æŠãƒãƒ¼ã‚¯å‰Šé™¤</button>
          <button type="button" class="btn btn-secondary btn-small" id="clearTradesBtn">ğŸ§¹ å…¨ãƒãƒ¼ã‚¯å‰Šé™¤</button>
        </div>
        <div id="tradeLog" style="font-size:0.9em;margin-top:8px;">â€”</div>
        <div id="plTotal" style="margin-top:8px;font-weight:bold;"></div>
        <div style="margin-top:10px;">
          <ul id="tradeList" class="manage-list">
            <li class="manage-item" style="justify-content:center;color:#6c757d;">ãƒãƒ¼ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“</li>
          </ul>
        </div>
      </div>

      <!-- ãƒ‡ãƒ¼ã‚¿ç®¡ç† -->
      <div class="control-group">
        <h3>ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h3>
        <button type="button" class="btn btn-secondary" id="downloadBtn">ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
        <button type="button" class="btn btn-primary" id="sampleBtn">ğŸ“Š ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿</button>
        <button type="button" class="btn btn-danger" id="clearBtn">ğŸ—‘ï¸ ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢</button>

        <!-- ä¿å­˜ã¾ã‚ã‚Š -->
        <div style="display:flex;gap:10px;margin-top:10px;flex-wrap:wrap;">
          <button type="button" class="btn btn-success btn-small" id="saveBtn">ğŸ“ ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜</button>
          <button type="button" class="btn btn-secondary btn-small" id="restoreBtn">â†©ï¸ ä¿å­˜ã‹ã‚‰å¾©å…ƒ</button>
          <label style="display:flex;align-items:center;gap:8px;">
            <input type="checkbox" id="autosaveToggle" checked>
            è‡ªå‹•ä¿å­˜ï¼ˆæ“ä½œã”ã¨ï¼‰
          </label>
        </div>
      </div>

      <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
      <div class="status-grid">
        <div class="status-card"><div class="status-value" id="lastUpdate">æœªå…¥åŠ›</div><div class="status-label">æœ€çµ‚å…¥åŠ›</div></div>
        <div class="status-card"><div class="status-value" id="dataCount">0</div><div class="status-label">ä¾¡æ ¼ãƒ‡ãƒ¼ã‚¿æ•°</div></div>
        <div class="status-card"><div class="status-value" id="currentPrice">---</div><div class="status-label">æœ€æ–°ä¾¡æ ¼</div></div>
        <div class="status-card"><div class="status-value" id="kagiCount">0</div><div class="status-label">ã‚«ã‚®ç·šæ•°</div></div>
      </div>

      <!-- å…¥åŠ›å±¥æ­´ï¼ˆé–²è¦§ï¼‹å‰Šé™¤ç®¡ç†ï¼‰ -->
      <div class="control-group">
        <h3>å…¥åŠ›å±¥æ­´</h3>
        <div class="recent-prices" id="recentPrices">
          <div style="text-align:center;color:#6c757d;padding:20px;">ä¾¡æ ¼ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>
        </div>
        <div style="margin-top:10px;">
          <ul id="priceList" class="manage-list">
            <li class="manage-item" style="justify-content:center;color:#6c757d;">å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</li>
          </ul>
        </div>
      </div>

      <div class="alert alert-info"><strong>ğŸ“Œ ä½¿ç”¨æ–¹æ³•:</strong><br>â€¢ è»¢æ›ç‡ 0.1% ã¯ç´„ 40 å††å¹…<br>â€¢ ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã§å‹•ä½œç¢ºèªã§ãã¾ã™</div>
      <div class="alert alert-warning"><strong>âš¡ æ³¨æ„äº‹é …:</strong><br>ãƒ‡ãƒ¼ã‚¿ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¸€æ™‚ä¿å­˜ã•ã‚Œã¾ã™ã€‚é‡è¦ãªãƒ‡ãƒ¼ã‚¿ã¯ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„</div>
    </div>

    <!-- å³ãƒ‘ãƒãƒ« -->
    <div class="chart-area">
      <!-- ãƒãƒ£ãƒ¼ãƒˆåˆ¶å¾¡ãƒ‘ãƒãƒ« -->
      <div class="chart-controls">
        <label>è¡¨ç¤ºç¯„å›²:</label>
        <input type="range" id="chartRange" min="0" max="100" value="100" step="1">
        <div class="range-info" id="rangeInfo">å…¨ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º</div>
        <div class="zoom-buttons">
          <button type="button" id="zoomOutBtn" title="è¡¨ç¤ºç¯„å›²ã‚’åºƒã’ã‚‹">ã‚ºãƒ¼ãƒ ã‚¢ã‚¦ãƒˆ</button>
          <button type="button" id="zoomInBtn" title="è¡¨ç¤ºç¯„å›²ã‚’ç‹­ã‚ã‚‹">ã‚ºãƒ¼ãƒ ã‚¤ãƒ³</button>
          <button type="button" id="latestBtn" title="æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«">æœ€æ–°</button>
        </div>
      </div>

      <div class="chart-container"><canvas id="kagiChart"></canvas></div>
      <div class="data-log" id="dataLog"><div class="log-entry"><span class="timestamp">ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•</span> - æ—¥çµŒ225å…ˆç‰©æ‰‹å‹•å…¥åŠ›ã‚·ã‚¹ãƒ†ãƒ é–‹å§‹</div></div>
    </div>

  </div>
</div>

<script>
/* ===== å…±é€šå¤‰æ•° ===== */
let chart=null, priceData=[], kagiData=[], trades=[];
let selectedIdx=null;
let selectedTradeIdx=null; // â˜…é¸æŠä¸­ã®ãƒˆãƒ¬ãƒ¼ãƒ‰ï¼ˆãƒãƒ£ãƒ¼ãƒˆã‹ã‚‰å‰Šé™¤ç”¨ï¼‰
let viewStart=0, viewEnd=0, maxViewWidth=20; // è¡¨ç¤ºåˆ¶å¾¡ç”¨å¤‰æ•°
const COLOR={buy:'#2ecc71', sell:'#e74c3c', pair:'#7f8c8d55'};
const SHAPE={buy:'triangle', sell:'rectRot'};
const STORAGE_KEY = 'kagi_manual_storage_v1';

/* ===== ä¿å­˜ãƒ»å¾©å…ƒ ===== */
function saveState(manual=false){
  try{
    const state = {
      savedAt: Date.now(),
      priceData,
      trades,
      reversalPercent: +document.getElementById('reversalPercent').value,
      maxViewWidth
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    if(manual) log('ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ã‚’å®Ÿè¡Œã—ã¾ã—ãŸ');
  }catch(e){
    console.error(e);
    alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆå®¹é‡/æ¨©é™ã®å¯èƒ½æ€§ï¼‰');
  }
}
function restoreState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw){ alert('ä¿å­˜ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
    const s = JSON.parse(raw);
    priceData     = Array.isArray(s.priceData) ? s.priceData : [];
    trades        = Array.isArray(s.trades)    ? s.trades    : [];
    if(typeof s.reversalPercent === 'number'){
      document.getElementById('reversalPercent').value = s.reversalPercent;
    }
    if(typeof s.maxViewWidth === 'number') maxViewWidth = s.maxViewWidth;

    document.getElementById('chartRange').value = 100;
    selectedIdx = null; selectedTradeIdx=null;
    drawChart();
    updatePriceList();
    updateTradeList();
    log('ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã—ãŸ');
  }catch(e){
    console.error(e);
    alert('å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆãƒ‡ãƒ¼ã‚¿ç ´æã®å¯èƒ½æ€§ï¼‰');
  }
}
function clearSavedState(){
  localStorage.removeItem(STORAGE_KEY);
}
function maybeAutoSave(){
  const auto = document.getElementById('autosaveToggle');
  if(auto && auto.checked) saveState(false);
}

/* ===== ã‚«ã‚®è¶³è¨ˆç®— & ãƒ‘ã‚¹ ===== */
function calcKagi(list,rev){
  if(!list.length) return [];
  const k=[],f=list[0];let last=f.price,trend=1;
  k.push({x:0,y:last,trend,timestamp:f.timestamp});
  for(let i=1;i<list.length;i++){
    const p=list[i].price,diff=p-last,chg=Math.abs(diff/last)*100;
    if(chg<rev) continue;
    const nt=diff>0?1:-1;
    if(nt!==trend){trend=nt;last=p;k.push({x:k.length,y:p,trend,timestamp:list[i].timestamp});}
    else if((trend===1&&p>last)||(trend===-1&&p<last)){last=p;k.push({x:k.length,y:p,trend,timestamp:list[i].timestamp});}
  }
  return k;
}
function toPath(d){
  if(d.length<2) return d;
  const r=[];let x=0;r.push({...d[0],x});
  for(let i=1;i<d.length;i++){
    if(d[i].trend!==d[i-1].trend){x++;r.push({x,y:d[i-1].y,isHorizontal:true,timestamp:d[i].timestamp});}
    r.push({x,y:d[i].y,trend:d[i].trend,isVertical:true,timestamp:d[i].timestamp});
  }
  return r;
}

/* ===== Chart åˆæœŸåŒ– ===== */
function initChart(){
  const ctx=document.getElementById('kagiChart').getContext('2d');
  chart=new Chart(ctx,{
    type:'line',
    data:{datasets:[
      {label:'kagi',data:[],borderWidth:4,borderColor:'#3498db',
       backgroundColor:'transparent',pointBorderColor:'#2c3e50',pointBorderWidth:2,tension:0},
      {type:'scatter',label:'trade',data:[],showLine:false,pointRadius:12,pointBorderWidth:3},
      {type:'line',label:'pair',data:[],showLine:true,fill:false,
       borderDash:[6,4],borderColor:COLOR.pair,pointRadius:0},
      {type:'scatter',label:'selected',data:[],showLine:false,
       pointRadius:12,pointStyle:'circle',pointBackgroundColor:'#f1c40f',
       pointBorderColor:'#2c3e50',pointBorderWidth:3},
      // â˜…é¸æŠä¸­ãƒˆãƒ¬ãƒ¼ãƒ‰ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ
      {type:'scatter',label:'tradeSelected',data:[],showLine:false,
       pointRadius:14,pointStyle:'circle',pointBackgroundColor:'#f1c40f',
       pointBorderColor:'#2c3e50',pointBorderWidth:4}
    ]},
    options:{
      responsive:true,
      interaction:{intersect:false,mode:'nearest'},
      plugins:{legend:{display:false}},
      scales:{
        x:{type:'linear',min:0,max:maxViewWidth},
        y:{ticks:{callback:v=>'Â¥'+Math.round(v).toLocaleString()}}
      }
    }
  });

  chart.canvas.addEventListener('click', onChartClick);
}

/* ===== è¡¨ç¤ºç¯„å›²åˆ¶å¾¡ ===== */
function updateViewRange(){
  if(!kagiData.length) return;

  const totalWidth = kagiData.length > 0 ? Math.max(...kagiData.map(p => p.x)) + 1 : 1;
  const rangeSlider = document.getElementById('chartRange');
  const rangeValue = parseInt(rangeSlider.value);

  const displayWidth = Math.min(maxViewWidth, totalWidth);

  if(rangeValue === 100) {
    viewEnd = totalWidth;
    viewStart = Math.max(0, viewEnd - displayWidth);
  } else {
    const maxStart = Math.max(0, totalWidth - displayWidth);
    viewStart = Math.floor((rangeValue / 100) * maxStart);
    viewEnd = Math.min(viewStart + displayWidth, totalWidth);
  }

  chart.options.scales.x.min = viewStart;
  chart.options.scales.x.max = viewEnd;

  const info = document.getElementById('rangeInfo');
  if(totalWidth <= maxViewWidth) {
    info.textContent = 'å…¨ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º';
    rangeSlider.disabled = true;
  } else {
    info.textContent = `${viewStart + 1}-${viewEnd} / ${totalWidth}`;
    rangeSlider.disabled = false;
  }
  rangeSlider.max = 100;
}

/* ===== ãƒšã‚¢ç·š ===== */
function updatePairLines(){
  const seg=[];let open=null;
  trades.forEach(t=>{
    if(!open){open=t;return;}
    if(open.type!==t.type){
      seg.push({x:open.x,y:open.y},{x:t.x,y:t.y},{x:NaN,y:NaN});
      open=null;
    }else{open=t;}
  });
  chart.data.datasets[2].data=seg;
}

/* ===== ãƒˆãƒ¬ãƒ¼ãƒ‰ä½ç½®ã®å†å‰²å½“ï¼ˆä¾¡æ ¼å‰Šé™¤å¾Œã®ä¿è­·ï¼‰ ===== */
function rebindTradesToKagi(){
  if(!kagiData.length || !trades.length) return;
  let changes=0;
  trades.forEach(t=>{
    let bestIdx=0, bestDist=Infinity;
    for(let i=0;i<kagiData.length;i++){
      const dx=kagiData[i].x - t.x, dy=kagiData[i].y - t.y;
      const dist = dx*dx + dy*dy;
      if(dist<bestDist){bestDist=dist;bestIdx=i;}
    }
    const newX=kagiData[bestIdx].x, newY=kagiData[bestIdx].y;
    if(newX!==t.x || newY!==t.y){ t.x=newX; t.y=newY; changes++; }
  });
  if(changes>0) log(`ãƒˆãƒ¬ãƒ¼ãƒ‰ä½ç½®ã‚’å†å‰²å½“: ${changes}ä»¶`);
}

/* ===== æç”» ===== */
function drawChart(){
  kagiData = toPath( calcKagi(priceData, +document.getElementById('reversalPercent').value) );

  /* kagi ç‚¹ */
  chart.data.datasets[0].data = kagiData.map(p=>({x:p.x,y:p.y}));
  chart.data.datasets[0].data.forEach((d,i)=>{
    d.radius      = kagiData[i].isHorizontal ? 7 : 10;
    d.hitRadius   = 15;
    d.hoverRadius = d.radius + 3;
    d.backgroundColor = kagiData[i].isHorizontal ? '#95a5a6'
                      : kagiData[i].trend===1 ? COLOR.buy : COLOR.sell;
    d.borderWidth = 2;
    d.borderColor = '#2c3e50';
  });

  /* trade ãƒãƒ¼ã‚«ãƒ¼ */
  chart.data.datasets[1].data = trades.map(t=>({x:t.x,y:t.y}));
  chart.data.datasets[1].pointBackgroundColor = trades.map(t=>COLOR[t.type]);
  chart.data.datasets[1].pointStyle           = trades.map(t=>SHAPE[t.type]);
  chart.data.datasets[1].pointBorderColor     = '#2c3e50';
  chart.data.datasets[1].pointRadius          = 12;
  chart.data.datasets[1].pointBorderWidth     = 3;

  // â˜…é¸æŠä¸­ãƒˆãƒ¬ãƒ¼ãƒ‰ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ
  if(selectedTradeIdx!==null && trades[selectedTradeIdx]){
    const st = trades[selectedTradeIdx];
    chart.data.datasets[4].data = [{x:st.x, y:st.y}];
  }else{
    chart.data.datasets[4].data = [];
  }

  updatePairLines();
  updateViewRange();
  highlightSelected(false);
  chart.update('active');
  updateTradeLog();updateStats();updateRecent();
}

/* ===== é¸æŠãƒã‚¤ãƒ©ã‚¤ãƒˆï¼ˆã‚«ã‚®ç‚¹ï¼‰ ===== */
function highlightSelected(updateChart=true){
  const ds = chart.data.datasets[3];
  ds.data = selectedIdx!==null ? [{x:kagiData[selectedIdx].x, y:kagiData[selectedIdx].y}] : [];
  if(updateChart) chart.update('active');
}

/* ===== ã‚¯ãƒªãƒƒã‚¯å‡¦ç† ===== */
function onChartClick(evt){
  const els = chart.getElementsAtEventForMode(evt,'nearest',{intersect:false,axis:'xy'},true);
  if(!els.length) return;
  const el = els[0];
  if(el.datasetIndex===0){ // kagi ç‚¹
    selectedIdx = el.index;
    highlightSelected();
  }else if(el.datasetIndex===1){ // trade ãƒãƒ¼ã‚«ãƒ¼
    selectedTradeIdx = el.index;
    drawChart(); // ãƒã‚¤ãƒ©ã‚¤ãƒˆåæ˜ 
  }
}

/* ===== å–å¼•å±¥æ­´ & æç›Š ===== */
function updateTradeLog(){
  const box=document.getElementById('tradeLog');
  if(!trades.length){box.innerHTML='â€”';document.getElementById('plTotal').textContent='';return;}
  let html='',plSum=0,open=null;
  trades.forEach((t,i)=>{
    const ts=new Date(t.timestamp).toLocaleTimeString();
    html+=`${i+1}. <span style="color:${COLOR[t.type]}">${t.type.toUpperCase()}</span> Â¥${t.y.toLocaleString()} (${ts})<br>`;
    if(!open){open=t;}
    else if(open.type!==t.type){
      plSum += open.type==='buy' ? t.y-open.y : open.y-t.y;
      open=null;
    }else{open=t;}
  });
  box.innerHTML=html;
  document.getElementById('plTotal').innerHTML=
    `ç´¯è¨ˆæç›Š: <span style="color:${plSum>=0?'#27ae60':'#e74c3c'}">${plSum>=0?'+':''}${plSum.toLocaleString()}</span>`;
}

/* ===== å…¥åŠ›å±¥æ­´ï¼ˆå³ä¸‹ãƒ­ã‚°ï¼‰ ===== */
function updateRecent(){
  const box=document.getElementById('recentPrices');
  if(!priceData.length){box.innerHTML='<div style="text-align:center;color:#6c757d;padding:20px;">ä¾¡æ ¼ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';return;}
  const recent=priceData.slice(-10).reverse();
  box.innerHTML=recent.map((d,i)=>{
    const diff=i<recent.length-1?d.price-recent[i+1].price:0,cls=diff>0?'price-up':diff<0?'price-down':'',sgn=diff>0?'+':'';
    return `<div class="price-entry"><span class="${cls}">Â¥${d.price.toLocaleString()} ${diff!==0?`(${sgn}${diff})`:''}</span><span class="price-time">${new Date(d.timestamp).toLocaleTimeString()}</span></div>`;
  }).join('');
}

/* ===== ç®¡ç†ç”¨ãƒªã‚¹ãƒˆï¼ˆå‰Šé™¤å¯¾å¿œãƒ»ã‚¤ãƒ™ãƒ³ãƒˆå§”ä»»ï¼‰ ===== */
function updatePriceList(){
  const ul = document.getElementById('priceList');
  if(!ul) return;
  ul.innerHTML = '';
  if(!priceData.length){
    ul.innerHTML = '<li class="manage-item" style="justify-content:center;color:#6c757d;">å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</li>';
    return;
  }
  priceData.forEach((d,i)=>{
    const li=document.createElement('li'); li.className='manage-item';
    li.innerHTML = `
      <div class="item-meta">
        <div>#${i+1} Â¥${d.price.toLocaleString()}</div>
        <small style="color:#7f8c8d;">${new Date(d.timestamp).toLocaleString()}</small>
      </div>
      <div class="item-actions">
        <button type="button" class="btn btn-danger btn-small" data-idx="${i}">å‰Šé™¤</button>
      </div>
    `;
    ul.appendChild(li);
  });
}
function updateTradeList(){
  const ul = document.getElementById('tradeList');
  if(!ul) return;
  ul.innerHTML = '';
  if(!trades.length){
    ul.innerHTML = '<li class="manage-item" style="justify-content:center;color:#6c757d;">ãƒãƒ¼ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“</li>';
    return;
  }
  trades.forEach((t,i)=>{
    const active = (i===selectedTradeIdx) ? 'font-weight:700;text-decoration:underline;' : '';
    const li=document.createElement('li'); li.className='manage-item';
    li.innerHTML = `
      <div class="item-meta" style="${active}">
        <div>#${i+1} <span style="color:${COLOR[t.type]};font-weight:700">${t.type.toUpperCase()}</span> Â¥${t.y.toLocaleString()}</div>
        <small style="color:#7f8c8d;">${new Date(t.timestamp).toLocaleString()}</small>
      </div>
      <div class="item-actions">
        <button type="button" class="btn btn-danger btn-small" data-tidx="${i}">å‰Šé™¤</button>
      </div>
    `;
    ul.appendChild(li);
  });
}

/* ã‚¤ãƒ™ãƒ³ãƒˆå§”ä»»ï¼ˆã‚¯ãƒªãƒƒã‚¯ã¯è¦ªULã§æ‹¾ã†ï¼‰ */
document.addEventListener('click', (e)=>{
  // å…¥åŠ›å±¥æ­´ã®å‰Šé™¤
  const priceBtn = e.target.closest('#priceList button[data-idx]');
  if(priceBtn){
    const idx = +priceBtn.dataset.idx;
    const removed = priceData.splice(idx,1)[0];
    log(`å…¥åŠ›å€¤å‰Šé™¤: #${idx+1} Â¥${removed.price.toLocaleString()}`);
    drawChart();
    rebindTradesToKagi();
    drawChart();
    updatePriceList();
    updateTradeList();
    maybeAutoSave();
    return;
  }
  // ãƒˆãƒ¬ãƒ¼ãƒ‰å±¥æ­´ã®å‰Šé™¤
  const tradeBtn = e.target.closest('#tradeList button[data-tidx]');
  if(tradeBtn){
    const idx = +tradeBtn.dataset.tidx;
    const r = trades.splice(idx,1)[0];
    if(selectedTradeIdx===idx) selectedTradeIdx=null;
    else if(selectedTradeIdx>idx) selectedTradeIdx--; // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹èª¿æ•´
    log(`ãƒãƒ¼ã‚¯å‰Šé™¤: #${idx+1} ${r.type.toUpperCase()} Â¥${r.y.toLocaleString()}`);
    drawChart();
    updateTradeList();
    maybeAutoSave();
    return;
  }
});

/* ===== ãƒ­ã‚° & ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ ===== */
function log(msg,diff=null){
  const log=document.getElementById('dataLog'),div=document.createElement('div');div.className='log-entry';
  const cls=diff==null?'':diff>0?'price-up':diff<0?'price-down':'';
  div.innerHTML=`<span class="timestamp">${new Date().toLocaleTimeString()}</span> - <span class="${cls}">${msg}</span>`;
  log.appendChild(div);log.scrollTop=log.scrollHeight;if(log.children.length>50)log.children[0].remove();
}
function updateStats(){
  document.getElementById('dataCount').textContent=priceData.length;
  document.getElementById('kagiCount').textContent=kagiData.length;
  if(priceData.length){
    const l=priceData[priceData.length-1];
    document.getElementById('currentPrice').textContent='Â¥'+l.price.toLocaleString();
    document.getElementById('lastUpdate').textContent=new Date(l.timestamp).toLocaleTimeString();
  }else{
    document.getElementById('currentPrice').textContent='---';
    document.getElementById('lastUpdate').textContent='æœªå…¥åŠ›';
  }
}

/* ===== æ“ä½œ ===== */
function addPrice(){
  const inp=document.getElementById('priceInput'),val=inp.value.trim();
  if(!val) return alert('ä¾¡æ ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
  const price=Math.round(parseFloat(val));if(isNaN(price)||price<=0) return alert('æ­£ã—ã„ä¾¡æ ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
  const ts=document.getElementById('datetimeInput').value?new Date(document.getElementById('datetimeInput').value).getTime():Date.now();
  priceData.push({timestamp:ts,price});
  const diff=priceData.length>1?price-priceData[priceData.length-2].price:0;log(`ä¾¡æ ¼è¿½åŠ : Â¥${price.toLocaleString()} (${diff>0?'+':''}${diff})`,diff);
  selectedIdx=null;
  drawChart();
  rebindTradesToKagi();
  drawChart();

  document.getElementById('chartRange').value = 100;
  updatePriceList();
  updateTradeList();
  maybeAutoSave();
  inp.value='';
}
function markSelected(){
  if(selectedIdx===null) return alert('ã¾ãšãƒãƒ£ãƒ¼ãƒˆä¸Šã®ã‚«ã‚®è¶³ç‚¹ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„');
  const type=document.getElementById('tradeType').value;
  const p = kagiData[selectedIdx];
  trades.push({x:p.x,y:p.y,type,timestamp:Date.now()});
  selectedTradeIdx = trades.length-1; // è¿½åŠ ã—ãŸã‚‚ã®ã‚’é¸æŠçŠ¶æ…‹ã«
  log(`${type==='buy'?'è²·ã„':'å£²ã‚Š'}ãƒãƒ¼ã‚¯: Â¥${p.y.toLocaleString()}`);
  selectedIdx=null; drawChart();
  updateTradeList();
  maybeAutoSave();
}
function deleteSelectedTrade(){
  if(selectedTradeIdx===null) return alert('å‰Šé™¤ã™ã‚‹ãƒãƒ¼ã‚¯ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼ˆãƒãƒ£ãƒ¼ãƒˆã®ãƒãƒ¼ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ï¼‰');
  const r = trades.splice(selectedTradeIdx,1)[0];
  log(`é¸æŠãƒãƒ¼ã‚¯å‰Šé™¤: ${r.type.toUpperCase()} Â¥${r.y.toLocaleString()}`);
  selectedTradeIdx=null;
  drawChart();
  updateTradeList();
  maybeAutoSave();
}
function clearAll(){
  if(!priceData.length && !trades.length) return alert('ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
  if(!confirm('å…¨ãƒ‡ãƒ¼ã‚¿ï¼ˆå…¥åŠ›ãƒ»ãƒãƒ¼ã‚¯ï¼‰ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
  priceData=[];kagiData=[];trades=[];selectedIdx=null; selectedTradeIdx=null;
  drawChart(); log('ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢');
  updatePriceList(); updateTradeList();
  maybeAutoSave();
}
function clearTrades(){
  if(!trades.length) return alert('ãƒãƒ¼ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“');
  if(!confirm('å…¨ã¦ã®å£²è²·ãƒãƒ¼ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
  trades=[]; selectedTradeIdx=null; drawChart(); log('å…¨ãƒãƒ¼ã‚¯ã‚’å‰Šé™¤');
  updateTradeList(); maybeAutoSave();
}
function addSample(){
  priceData=[];trades=[];selectedIdx=null; selectedTradeIdx=null;
  const prices=[40000,40500,39500,40500,40000,41000,39000,42000,38000,43000,37000,44000,36000,45000,35000,
                46000,34000,47000,33000,48000,32000,47500,33500,46000,35000,44500,36500,43000,38000,41500];
  const base=Date.now()-prices.length*60000;
  prices.forEach((p,i)=>priceData.push({timestamp:base+i*60000,price:p}));
  log('é•·ã„ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿è¿½åŠ '); 
  drawChart();
  document.getElementById('chartRange').value = 100;
  updatePriceList(); updateTradeList();
  maybeAutoSave();
}

/* ===== CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆãƒ¢ãƒã‚¤ãƒ«å…±æœ‰ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰ ===== */
function downloadCSV(){
  if(!priceData.length) return alert('ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
  const csv='timestamp,datetime,price\n'+priceData.map(d=>`${d.timestamp},${new Date(d.timestamp).toLocaleString()},${d.price}`).join('\n');
  const blob=new Blob([csv],{type:'text/csv'});
  const fname='nikkei225_'+new Date().toISOString().slice(0,10)+'.csv';
  try{
    const file=new File([blob], fname, {type:'text/csv'});
    if(navigator.canShare && navigator.canShare({files:[file]})){
      navigator.share({files:[file], title:'ã‚«ã‚®è¶³ãƒ‡ãƒ¼ã‚¿', text:'CSVãƒ‡ãƒ¼ã‚¿'});
      log(`ãƒ‡ãƒ¼ã‚¿å…±æœ‰: ${priceData.length}ä»¶`);
      return;
    }
  }catch(e){ /* iOS < 15 ãªã© File æœªå¯¾å¿œ */ }
  const url=URL.createObjectURL(blob), a=document.createElement('a');
  a.href=url; a.download=fname; a.click(); URL.revokeObjectURL(url);
  log(`ãƒ‡ãƒ¼ã‚¿DL: ${priceData.length}ä»¶`);
}

/* ===== ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«åˆ¶å¾¡ã‚¤ãƒ™ãƒ³ãƒˆ ===== */
function setupScrollControls(){
  const rangeSlider = document.getElementById('chartRange');
  const zoomOutBtn = document.getElementById('zoomOutBtn');
  const zoomInBtn = document.getElementById('zoomInBtn');
  const latestBtn = document.getElementById('latestBtn');

  rangeSlider.addEventListener('input', function() {
    updateViewRange();
    chart.update('active');
  });

  zoomOutBtn.addEventListener('click', function() {
    maxViewWidth = Math.min(maxViewWidth + 5, 50);
    updateViewRange();
    chart.update('active');
    maybeAutoSave();
  });

  zoomInBtn.addEventListener('click', function() {
    maxViewWidth = Math.max(maxViewWidth - 5, 5);
    updateViewRange();
    chart.update('active');
    maybeAutoSave();
  });

  latestBtn.addEventListener('click', function() {
    rangeSlider.value = 100;
    updateViewRange();
    chart.update('active');
    maybeAutoSave();
  });
}

/* ===== ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ² ===== */
document.getElementById('addPriceBtn').onclick=addPrice;
document.getElementById('priceInput').addEventListener('keypress',e=>{if(e.key==='Enter')addPrice();});
document.getElementById('addTradeBtn').onclick=markSelected;
document.getElementById('deleteSelectedTradeBtn').onclick=deleteSelectedTrade;
document.getElementById('clearTradesBtn').onclick=clearTrades;
document.getElementById('recalculateBtn').onclick=()=>{ if(priceData.length){ drawChart(); rebindTradesToKagi(); drawChart(); } };
document.getElementById('reversalPercent').onchange=()=>{
  if(priceData.length){ drawChart(); rebindTradesToKagi(); drawChart(); }
  maybeAutoSave();
};
document.getElementById('sampleBtn').onclick=addSample;
document.getElementById('clearBtn').onclick=clearAll;
document.getElementById('downloadBtn').onclick=downloadCSV;
document.getElementById('saveBtn').onclick    = () => saveState(true);
document.getElementById('restoreBtn').onclick = restoreState;

/* é›¢è„±æ™‚ã®ä¿é™ºä¿å­˜ */
window.addEventListener('beforeunload', () => {
  const auto = document.getElementById('autosaveToggle');
  if(auto && auto.checked) saveState(false);
});

/* ===== PWA: Service Worker ç™»éŒ² ===== */
if('serviceWorker' in navigator){
  window.addEventListener('load', ()=>{
    navigator.serviceWorker.register('./sw.js').catch(console.error);
  });
}

/* ===== åˆæœŸåŒ– ===== */
window.onload=()=>{
  initChart(); 
  setupScrollControls();
  log('æ‰‹å‹•å…¥åŠ›ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†');
  const now=new Date();now.setMinutes(now.getMinutes()-now.getTimezoneOffset());
  document.getElementById('datetimeInput').value=now.toISOString().slice(0,16);

  if(localStorage.getItem(STORAGE_KEY)){
    restoreState();
  } else {
    log('ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
  }
  updatePriceList();
  updateTradeList();
};
</script>
</body>
</html>
